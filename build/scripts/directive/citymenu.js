lbiApp.directive("citymenu",["safeApply","$timeout","cityListResource",function(a,b,c){var d=function(){return{pre:function(){},post:e}},e=function(a,b,d){a.citylist=[];var e="false"===d.isLocalSource?!1:!0;e?c.query().then(function(c){f(a,b,d,c)}):d.$observe("source",function(c){var e=/\[.+\]/;c&&e.test(c)&&(c=JSON.parse(c),f(a,b,d,c))})},f=function(c,d,e,f){c.citylist=f,c.hotCitylist=[];var g="北京市,上海市,广州市,深圳市,杭州市,天津市,成都市,重庆市",h=function(a){var b=[];return $.each(a,function(a,d){b=b.concat(d.citys),$.each(d.citys,function(a,b){-1!=g.indexOf(b.cityname)&&c.hotCitylist.push(b)})}),b},i=h(c.citylist);c.defaultCity=c.hotCitylist.length?c.hotCitylist[0].cityname:f[0].citys[0].cityname;var j=$("#city-srh-ipt",d),k=function(a,b){return $.grep(a,function(a){return b=b.toUpperCase(),-1!==a.cityname.indexOf(b)})};j.typeahead({highlight:!0},{name:"states",displayKey:"cityname",source:function(a,b){b(k(i,a))},templates:{empty:['<div class="empty-message">',"未找到对应城市","</div>"].join("\n"),suggestion:Handlebars.compile("<p>{{cityname}}</p>")}}),j.on("typeahead:selected",function(b,d){a(c,function(){l(d)})});var l=function(a){c.defaultCity=a.cityname,c.display=!1,c.checkedcall({poi:$.extend(a,{lng:a.x,lat:a.y})})};c.selectcity=function(a){l(a)};var m=function(a){var b=-1;$.each(i,function(c,d){return-1!==d.cityname.indexOf(a)?(b=c,!1):void 0}),-1!=b&&l(i[b])},n=Boolean(e.localReq);n?b(function(){m(c.defaultCity)},100):m(c.defaultCity)};return{templateUrl:"citymenu.html",compile:d,scope:{checkedcall:"&"}}}]);