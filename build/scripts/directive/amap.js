lbiApp.directive("amap",["safeApply",function(safeApply){return{require:"ngModel",link:function($scope,iElm,iAttrs,ngModel){var func=arguments.callee,init_offset=iElm.offset();if(0==init_offset.left||0==init_offset.right)return setTimeout(function(){func.call(window,$scope,iElm,iAttrs,ngModel)},20),!1;var mapObj,options=iAttrs.mapoptions,mapOption={scrollWheel:!1,center:new AMap.LngLat(116.368904,39.913423)},ele=iElm[0];mapObj=new AMap.Map(ele,mapOption),mapObj.setZoom(13),mapObj.plugin(["AMap.OverView","AMap.ToolBar"],function(){var a=new AMap.OverView({visible:!1});mapObj.addControl(a);var b=new AMap.ToolBar;mapObj.addControl(b)}),iAttrs.$observe("center",function(){var lnglat=$scope.center;return"string"===$.type(lnglat)&&/^\[.+\]$/.test(lnglat)&&(lnglat=eval("{"+lnglat+"}")),lnglat&&lnglat.length?void mapObj.setCenter(new AMap.LngLat(lnglat[0],lnglat[1])):!1}),safeApply($scope,function(){ngModel.$setViewValue(mapObj)}),iAttrs.$observe("bound",function(a){if("undefined"==$.type(a)||0==a.length)return!1;try{a=JSON.parse(a);var b=new AMap.Bounds(a.southwest,a.northeast);mapObj.setBounds(b)}catch(c){}})}}}]),lbiApp.directive("amapdrawcover",function(){var a=function(b,c,d,e){var f=e.$viewValue;if("object"!==$.type(f))return setTimeout(function(){a(b,c,d,e)},100),!1;var g,h,i=function(a,b,c){g=new AMap.Circle($.extend({center:new AMap.LngLat(a[0],a[1]),radius:Number(b)},c)),g.setMap(f),f.setFitView([g])},j=function(a,b){var c=[];$.each(a,function(a,b){var d=b.split(" ");c.push(new AMap.LngLat(d[0],d[1]))}),g=new AMap.Polygon($.extend({path:c},b)),g.setMap(f),f.setFitView([g])};d.$observe("coverObj",function(a){if(!a)return!1;if(a=JSON.parse(a),!a.hasOwnProperty("center")||!a.center||!a.center.length)return!1;h=a.hasOwnProperty("wkt")&&a.wkt&&a.wkt.length?"polygon":"circle",g&&g.setMap(null),g=void 0;var b=a.center,c=a.wkt,d=a.radius,e=$.extend({zIndex:2,strokeColor:"#0000FF",strokeOpacity:.8,strokeWeight:3,fillColor:"#ee2200",fillOpacity:.2},a.options);"circle"==h&&i(b,d,e),"polygon"==h&&j(c,e)})};return{require:"^?ngModel",link:a}}),lbiApp.directive("amapsearch",[function(){var a=function(b,c,d,e){var f=e.$viewValue,g=d.city;if("object"!==$.type(f))return setTimeout(function(){a(b,c,d,e)},100),!1;var h,i=function(a){return a.length?void("object"==$.type(h)&&h.search(a)):!1},j=function(a){var c=[];"OK"==a.info&&(c=a.poiList.pois),b.$emit("UPDATE_DATASOURCE",c)};f.plugin(["AMap.PlaceSearch"],function(){h=new AMap.PlaceSearch({pageSize:10,pageIndex:1,extensions:"all",city:g}),AMap.event.addListener(h,"complete",j)}),d.$observe("city",function(a){"object"==$.type(h)&&h.setCity(a)}),d.$observe("searchkey",function(a){return a?void i(a):!1})};return{terminal:!0,require:"^?ngModel",link:a}}]),lbiApp.directive("amapicons",["safeApply",function(a){var b=function(c,d,e,f){var g=f.$viewValue;if("object"!==$.type(g))return setTimeout(function(){b(c,d,e,f)},100),!1;var h=[],i=(Number(e.iconsize)||10,e.mouseovericon,"true"==e.isFitView?!0:!1),j=(e.mouseouticon,function(b){$.each(h,function(a,b){b.setMap(null)}),h=[];{var d,f=[];e.limit||1}if($.each(b,function(b,i){var j=new AMap.LngLat(i.x,i.y);f.push(j);var k=new AMap.Marker({zIndex:110,position:j}),l=document.createElement("div");l.textContent=e.icontext||b+1,l.className=e.iconclass||"amapicon-normal";var m=e.tipkey&&i[e.tipkey],n=e.tipclass||"icontip";k.setContent(l),AMap.event.addListener(k,"click",function(){c.iconClick&&a(c,function(){c.iconClick({poi:i})})}),m&&AMap.event.addListener(k,"mouseover",function(){d=new AMap.Marker({position:j,offset:new AMap.Pixel(-24,-60),content:'<p class="'+n+'">'+m+"</p>"}),d.setMap(g)}),m&&AMap.event.addListener(k,"mouseout",function(){d&&d.setMap(null),d=null}),k.setMap(g),h.push(k)}),i){var j=new AMap.Polygon({path:f});g.setFitView([j])}});e.$observe("marklnglats",function(a){return""==a?!1:"array"!==$.type(JSON.parse(a))?!1:void j(JSON.parse(a))}),e.$observe("icontext",function(a){return h&&h.length&&a&&a.length?void $.each(h,function(b,c){var d=c.getContent();d.textContent=a,c.setContent(d)}):!1})};return{terminal:!0,scope:{iconClick:"&"},require:"^?ngModel",link:b}}]),lbiApp.directive("amapcovers",["safeApply",function(a){var b=function(c,d,e,f){var g=f.$viewValue;if("object"!==$.type(g))return setTimeout(function(){b(c,d,e,f)},100),!1;var h=[],i=[],j={strokeWeight:2,strokeColor:"#0000FF",strokeOpacity:.8,fillColor:"#CCF3FF",fillOpacity:.2},k=(e.limit||1,"false"==e.isFitView?!1:!0),l=function(b,d){var e,f=[];d.hasOwnProperty("wkt")&&d.wkt.length?($.each(d.wkt,function(a,b){var c=b.split(" ");f.push(new AMap.LngLat(c[0],c[1]))}),e=new AMap.Polygon($.extend({path:f},j))):e=new AMap.Circle($.extend({center:new AMap.LngLat(d.lng,d.lat),radius:Number(d.radius)},j)),e.setExtData(d),AMap.event.addListener(e,"mouseover",function(){a(c,function(){c.updatedCover&&c.updatedCover({poi:d,index:b})})}),AMap.event.addListener(e,"mouseout",function(){a(c,function(){c.updatedCover&&c.updatedCover({poi:{},index:-1})})}),e.setMap(g),h.push(e)},m=function(a){$.each(h,function(a,b){b.setMap(null)}),h=[],$.each(a,l),k&&g.setFitView(h)};e.$observe("covers",function(a){return""==a?!1:JSON.parse(a)&&"array"===$.type(JSON.parse(a))?(i=JSON.parse(a),void m(i)):!1}),e.$observe("zoom",function(){var a;return function(b){if(isNaN(b)||!h[b]||a==b)return!1;h[a]&&h[a].setOptions({zIndex:10,strokeColor:"#0000FF",fillOpacity:"0.2"}),a=b,h[a].setOptions({zIndex:11,strokeColor:"#ff0000",fillOpacity:"0.5"});var d=h[a].getBounds().getCenter();g.setCenter(d),g.setFitView([h[a]]),c.zoomEnd&&c.zoomEnd({item:h[a].getExtData(),bound:h[a].getBounds()})}}())};return{require:"^?ngModel",link:b,scope:{updatedCover:"&",zoomEnd:"&"}}}]),lbiApp.directive("amaptile",["$timeout",function(){var a=function(b,c,d,e){{var f,g=e.$viewValue;d.city}return"object"!==$.type(g)?(setTimeout(function(){a(b,c,d,e)},100),!1):void b.$watch("tileParams",function(a){if(!a||"object"!=$.type(a)||$.isEmptyObject(a))return!1;var b=Number(d.tileSize);f&&f.setMap(null),f=void 0,$.isEmptyObject(a)||(f=new AMap.TileLayer({tileSize:256,zIndex:110,getTileUrl:function(c,d,e){return html5Draw(c,d,e,a.gids.split(","),a.bound,b,a.legend)}}),f.setOpacity(.8),f.setMap(g))})};return{require:"^?ngModel",link:a,scope:{tileParams:"="}}}]),lbiApp.directive("amapPlacelayer",[function(){var a=function(b,c,d,e){var f=e.$viewValue;return"object"!==$.type(f)?(setTimeout(function(){a(b,c,d,e)},100),!1):void f.plugin("AMap.PlaceSearchLayer",function(){var a=new AMap.PlaceSearchLayer({key:""});d.$observe("lnglat",function(a){if(!a)return!1;a=JSON.parse(a);var a=new AMap.LngLat(a.lng,a.lat);f.setCenter(a)}),d.$observe("searchkey",function(b){return f.setStatus({zoomEnable:!0}),b?(a.setMap(null),a.setKeywords(b),void a.setMap(f)):!1}),AMap.event.addListener(a,"complete",function(){f.setZoom(11)})})};return{require:"^?ngModel",link:a}}]),lbiApp.directive("amapAreaRank",["safeApply","tileLegend",function(a){var b=["#f05b6b","#fcaf52","#b1ce24","#dddddd"],c=function(d,e,f,g){var h=g.$viewValue;if("object"!==$.type(h))return setTimeout(function(){c(d,e,f,g)},100),!1;var i,j,k,l,m,n,o=[],p={strokeWeight:1,strokeColor:"#ffffff",strokeOpacity:.8,fillOpacity:.9},q=f.idkey||"id",r=f.namekey||"name",s=f.namekey||"count",t="false"==f.updateEnabled?!1:!0,u="false"===f.clickEnabled?!1:!0,v=("false"==f.isFitView?!1:!0,function(a,c){var d=b[3];return c=Number(c),$.each(a,function(a,b){return Math.max(b.max,c)==b.max&&Math.min(b.min,c)==b.min?(d=b.color,!1):void 0}),d}),w=function(a){o[l]&&o[l].setOptions({fillColor:o[l].getExtData().color,fillOpacity:.9,strokeColor:"#ffffff",zIndex:10}),l=a,k=o[a].getExtData().id,h.setFitView([o[a]]);var b=o[a].getExtData();o[a].setOptions({fillColor:"#ffffff",fillOpacity:.8,strokeColor:"#f00"}),d.showItemCounty&&d.showItemCounty({bound:o[a].getBounds(),info:b})},x=function(a,b){var c,d,e,f=v(n,b[s]),g=[];$.each(b.wkt,function(a,b){var c=b.split(" ");g.push(new AMap.LngLat(c[0],c[1]))}),d=new AMap.Polygon($.extend({},p,{fillColor:f,path:g})),d.setMap(h),o.push(d),e=d.getBounds().getCenter(),c=new AMap.Marker({position:e,offset:new AMap.Pixel(0,-9),content:'<p class="district_name">'+b.name+"</p>"}),c.setMap(h),d.setExtData({name:b[r],id:b[q],count:b[s],color:f,marker:c}),AMap.event.addListener(d,"click",function(){u&&w(a)}),AMap.event.addListener(d,"mouseover",function(){var a;a=isNaN(b[s])||Number(b[s])<=150?"少量":"约"+b[s]+"人",m=new AMap.Marker({position:e,offset:new AMap.Pixel(-24,-60),content:'<p class="district_count">'+b[r]+"人口数:"+a+"</p>"}),m.setMap(h),m.setTop(!0)}),AMap.event.addListener(d,"mouseout",function(){m&&m.setMap(null),m=void 0,c.show()})};d.$watch("rank",function(a){if("array"!==$.type(a))return!1;0!=a.length&&(n=JSON.parse(f.rankLegend));var b=!0;if($.each(d.rank,function(a,c){return c[q]==i?(b=!1,!1):void 0}),!b&&t){var c=-1;$.each(a,function(a,b){var d=v(n,b[s]);o[a].setExtData({name:b[r],id:b[q],count:b[s],color:d,marker:o[a].getExtData().marker}),o[a].setOptions({fillColor:d}),b[q]==k&&(c=a)}),-1!==c&&(d.showItemCounty&&d.showItemCounty({bound:o[c].getBounds(),info:o[c].getExtData()}),w(c))}else{if($.each(o,function(a,b){b.getExtData().marker.setMap(null),b.setMap(null)}),o=[],0==a.length)return h.clearMap(),k=void 0,l=void 0,i=void 0,!1;$.each(a,function(a,b){x(a,b)}),i=a[0][q];var e=[];$.each(o,function(a,b){e=e.concat(b.getPath())});var g=new AMap.Polygon({path:e});j=g.getBounds(),h.setFitView(o)}}),f.$observe("zoom",function(a){return isNaN(a)||!o[a]?!1:void w(Number(a))}),f.$observe("zoomvalue",function(a){if(!d.rank||!d.rank.length)return!1;var b,c=f.zoomkey||"name";$.each(d.rank,function(d,e){e[c]==a&&(b=d)}),!isNaN(b)&&w(b)});var y=!1;AMap.event.addListener(h,"zoomend",function(){if(!d.rank||!d.rank.length||d.rank.length!=o.length)return!1;$.each(o,function(a,b){var c=b.getBounds(),d=b.getExtData(),e=d.marker,f=c.getNorthEast(),g=c.getSouthWest(),i=h.lnglatToPixel(f),j=h.lnglatToPixel(g),k=Math.abs(i.x-j.x),l=Math.abs(i.y-j.y);e.setContent(10>k||10>l?'<p class="rank_index" style="background:'+d.color+';">'+(a+1)+"</p>":'<p class="district_name">'+d.name+"</p>")});var b=h.getBounds(),c=b.getNorthEast(),e=b.getSouthWest(),f=c.distance(e),g=j.getNorthEast(),i=j.getSouthWest(),l=g.distance(i);f>l&&(h.setFitView(o),k="",a(d,function(){y&&d.showAllCountys&&d.showAllCountys()})),lastZoom=h.getZoom(),y=l>f})};return{scope:{rank:"=",showAllCountys:"&",showItemCounty:"&"},require:"^?ngModel",link:c}}]),lbiApp.directive("amapmenu",["safeApply",function(a){var b=function(c,d,e,f){var g=f.$viewValue;return"object"!==$.type(g)?(setTimeout(function(){b(c,d,e,f)},100),!1):void AMap.event.addListener(g,"rightclick",function(b){var d="true"==e.addEnable?!0:!1;return d?void(c.clickCall&&a(c,function(){c.clickCall({e:b})})):!1})};return{require:"^?ngModel",scope:{clickCall:"&"},link:b}}]);