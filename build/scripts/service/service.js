var lbiApp=angular.module("lbiApp");lbiApp.factory("safeApply",["$rootScope",function(){return function(a,b){var c=a.$root&&a.$root.$$phase;"$apply"==c||"$digest"==c?b&&a.$eval(b):b?a.$apply(b):a.$apply()}}]),lbiApp.factory("lbiService",["$http","$timeout","userStatus","$rootScope","$q",function(a,b,c,d,e){function f(b){var d=e.defer();if(!g.hasOwnProperty(b))return d.reject("接口不存在"),d.promise;var f=(g[b],Array.prototype.splice.call(arguments,1)),h=f[0],i=f[1],j={},k=i||"GET";return c.then(function(c){var e=c.memberId;j={memberId:e},"object"===$.type(h)&&(j=$.extend(h,j)),"POST"===k.toUpperCase()?a({url:g[b],method:"POST",data:$.param(j),headers:{"Content-Type":"application/x-www-form-urlencoded;chartset=utf-8"}}).success(function(a){return a.success?d.resolve(a.info):d.reject(a.desc,a.errorcode),!1}):a({url:g[b],method:"GET",params:j}).success(function(a){a.success&&0!==a.info.length?d.resolve(a.info):d.reject(a.desc,a.errorcode)})}),d.promise}var g={circleList:"/lbi/bizArea/querybizAreaByPage",sysCirclelist:"/lbi/bizArea/querySysbizArea",delCircle:"/lbi/bizArea/delbizArea",addCircle:"/lbi/bizArea/addbizArea",getGids:"/lbi/tile/getGids",getLegends:"/lbi/tile/getLegends",getCurPoi:"/lbi/bizArea/queryById",memberFileList:"/lbi/member/fileList",getShopCount:"/lbi/member/getMemberFileCount",getLocation:"/lbi/baseInfo/getIpInfo",get_categlorys:"/lbi/category/querySubCats",get_brands:"/lbi/category/queryBrand",addBaseInfo:"/lbi/baseInfo/addBaseInfo",updateBrand:"/lbi/category/setbrand",updateCat:"/lbi/category/setcategory",getFileInfo:"/lbi/member/getFileInfo",getfetureLabels:"/lbi/member/getTags",getCrowdCount:"/lbi/crowd/getCount",getDistribeCount:"/lbi/crowd/cityDistribe",getCount:"/lbi/tile/getCount",getTagDateRange:"/lbi/crowd/getTagEndDate",createCrowd:"/lbi/crowd/createCrowd",sign_agreement:"/lbi/firlogin/agreeItem",getMemberMsg:"/lbi/member/getPortraits",getFavBrands:"/lbi/category/queryBrandByUser",getFavCats:"/lbi/category/queryCatsByUser",getRankOfArea:"/lbi/saleRank/getCatDistSort",getCatUndBrandSort:"/lbi/saleRank/getCatUndBrandSort",getRankOfCircleByNum:"/lbi/bizRank/getBizRankByNum",getRankOfCircleByShop:"/lbi/bizRank/getBizRankByShop",getRankOfCircleByCat:"/lbi/bizRank/getBizRankByCategory",getRankOfCircleByBrand:"/lbi/bizRank/getBizRankByBrand",getFiles:"/lbi/brand/getBrandFile",delShopFile:"/lbi/brand/deleteBrandFile",getPhysicalStoreList:"/lbi/brand/getRecordFileByPage",getCitylist:"/lbi/baseInfo/getProvinceCity",getCitylistByFilter:"/lbi/baseInfo/getProvinceCityCount",judgeGidsLen:"/lbi/crowd/judgeGidsLen",queryMyPois:"/lbi/poitype/getuserpoitype",removePoi:"/lbi/poitype/removePoiType",addPoi:"/lbi/poitype/addPoiType",recommendPois:"/lbi/poitype/queryhottypes",searchPois:"/lbi/poitype/querytypes",print:"/lbi/brand/print",gonePOIRank:"/lbi/gonePOI/gonePOIRank",getActivitys:"/lbi/sds/getActivitys",getEffectAnalysis:"/lbi/sds/getEffectAnalysis",getTrades:"/lbi/trade/getTrades",getSecondSelectTag:"/lbi/trade/getSelects"};return f}]),lbiApp.factory("superCat",["$q","lbiService",function(a,b){var c=a.defer();return b("get_categlorys").then(function(a){c.resolve(a)}),c.promise}]),lbiApp.factory("formatwkt",[function(){var a=/(\d{2,3}\.\d+\S.\d{2,3}\.\d+)/g;return function(b){if("string"!==$.type(b)||!b.length)return!1;var c=b.match(a);return c&&c.length?c:""}}]),lbiApp.factory("fetureLabels",["lbiService","$q",function(a,b){var c=b.defer();return a("getfetureLabels").then(function(a){c.resolve(a)}),c.promise}]),lbiApp.factory("myBrandResource",["lbiService","$q",function(a,b){var c,d,e={query:"getFavBrands",update:"updateBrand"},f=!1,g=!1,h=[],i=function(b){if(f){b.resolve(d);var c=h.pop();c&&i(c)}else g=!0,a(e.query).then(function(a){f=!0,d=a,b.resolve(a),g=!1;var c=h.pop();c&&i(c)})},j=function(){return c=b.defer(),g?h.push(c):i(c),c.promise},k=function(b){a(e.update,b,"POST").then(function(){f=!0})};return{query:j,update:k}}]),lbiApp.factory("myCatResource",["lbiService","$q",function(a,b){var c,d,e={query:"getFavCats",update:"updateCat"},f=!1,g=!1,h=[],i=function(b){if(f){b.resolve(d);var c=h.pop();c&&i(c)}else g=!0,a(e.query).then(function(a){f=!0,d=a,b.resolve(a),g=!1;var c=h.pop();c&&i(c)})},j=function(){return c=b.defer(),g?h.push(c):i(c),c.promise},k=function(b){a(e.update,b,"POST").then(function(){f=!0})};return{query:j,update:k}}]),lbiApp.factory("myPoiResource",["lbiService","$q",function(a,b){var c,d=[],e=!1,f={query:"queryMyPois",add:"addPoi",del:"removePoi"},g=function(){return c=b.defer(),e?c.resolve(d):a(f.query).then(function(a){e=!0,d=a,c.resolve(a)},function(){c.reject()}),c.promise},h=function(b){a(f.add,b,"POST").then(function(){e=!1})},i=function(b){a(f.del,b,"POST").then(function(){e=!1})};return{query:g,add:h,del:i}}]),lbiApp.factory("offlineListResource",["lbiService","$q",function(a,b){var c,d,e={query:"memberFileList"},f=!1,g=!1,h=[],i=function(b){if(f){b.resolve(d);var c=h.pop();c&&i(c)}else g=!0,a(e.query).then(function(a){f=!0,d=a,b.resolve(a),g=!1;var c=h.pop();c&&i(c)})},j=function(){return c=b.defer(),g?h.push(c):i(c),c.promise};return{query:j}}]),lbiApp.factory("cityListResource",["$q","lbiService",function(a,b){var c,d,e={query:"getCitylist"},f=!1,g=!1,h=[],i=function(a){if(f){a.resolve(d);var c=h.pop();c&&i(c)}else g=!0,b(e.query).then(function(b){f=!0,d=b,a.resolve(b),g=!1;var c=h.pop();c&&i(c)})},j=function(){return c=a.defer(),g?h.push(c):i(c),c.promise};return{query:j}}]),lbiApp.factory("tagEnitySwitch",[function(){return function(a){var b=a||{},c=[];return $.each(b,function(a,b){c.push({id:a,value:b})}),JSON.stringify(c)}}]),lbiApp.factory("getGridTileLegend",["$q","lbiService",function(a,b){var c=function(c){var d=a.defer();return b("getLegends",c,"POST").then(function(a){return a.length>1?d.resolve({legends:a,size:600}):b("getLegends",$.extend(c,{size:1200}),"POST")}).then(function(a){d.resolve({legends:a,size:1200})}),d.promise};return c}]),lbiApp.factory("tileLegend",[function(){var a=["#eeea27","#b1ce24","#48a935","#176a58","#1d386f","#522661","#d72229"],b=["#eeea27","#b1ce24","#48a935","#522661","#d72229"];return function(c,d){for(var e=0,f=[],g=d&&"rank"==d?b:a,h=0,i=c.length;i>h;h++)f.push({min:e,max:c[h],color:g[h]}),e=Number(c[h])+1;return f}}]),lbiApp.factory("onlineShoplist",["$q","$http",function(a,b){var c=/(g\.tbcdn\.cn\/mm|100\.67\.1\.96\/g\/mm)/,d=a.defer(),e="http://dmp.taobao.com/api/login/loginuserinfo?callback=JSON_CALLBACK",f=[{dataId:"1590050090",name:"英特尔品牌站",type:"BRAND_SITE"},{dataId:"894685532",name:"小狗品牌站",type:"BRAND_SITE"},{dataId:"20316",name:"Nestle/雀巢",type:"BRAND"},{dataId:"10246",name:"Philips/飞利浦",type:"BRAND"},{dataId:"11119",name:"Lenovo/联想",type:"BRAND"},{dataId:"1916101543",name:"银泰百货杭州城西店",type:"O2O_BC"}],g=function(){c.test(TCDN_HOST)?b.jsonp(e).success(function(a){a.info.ok&&a.data.empowers&&a.data.empowers.length?d.resolve(a.data.empowers):d.reject()}):d.resolve(f)};return g(),d.promise}]),lbiApp.factory("querycircleByBatch",["$q","lbiService","formatwkt",function(a,b,c){var d,e,f,g=function(g){return d=a.defer(),e=g.length,f=[],$.each(g,function(a,g){b("getCurPoi",{id:g}).then(function(a){var b=a[0];f.push(b.hasOwnProperty("wkt")&&b.wkt.length?{wkt:c(b.wkt),id:g}:{lng:b.x,lat:b.y,id:g,radius:b.radius}),f.length==e&&d.resolve(f)})}),d.promise};return g}]),lbiApp.factory("judgeCircleGidsLen",["lbiService","$q",function(a,b){var c=function(c){var d=b.defer();return a("judgeGidsLen",c,"POST").then(function(){d.resolve()},function(a,b){d.reject(a,b)}),d.promise};return c}]),lbiApp.factory("judgeCircleCountLen",["lbiService","$q",function(a,b){var c=function(a){var c=b.defer();switch(a.type){case"C0":var d="商圈个数过多,最多支持200个商圈";a.ids.split(",").length<=200?c.resolve():c.reject(d);break;case"C1":var d="商圈个数过多,最多支持200个商圈";a.ids.split(",").length<=200?c.resolve():c.reject(d);break;case"C2":var d="实体店个数过多,最多支持200个实体店";a.regions.split(";").length<=200?c.resolve():c.reject(d);break;case"C3":var d="POI个数过多,最多支持200个POI点";a.regions.split(";").length<=200?c.resolve():c.reject(d)}return c.promise};return c}]),lbiApp.factory("queryPlaceBySearchPoi",["$q",function(a){var b,c;AMap.service(["AMap.PlaceSearch"],function(){b=new AMap.PlaceSearch({pageSize:30,pageIndex:1,city:"010"})});var d=function(d){return c=a.defer(),b.setCity(d.city),b.setPageIndex(d.page||1),b.setPageSize(d.pagesize||10),b.search(d.key,function(a,b){if("complete"==a&&"OK"==b.info){var d=b.poiList.pois,e=b.poiList.count,f=b.poiList.pageSize;c.resolve({pois:d,totalPage:Math.ceil(e/f),count:e})}else c.reject()}),c.promise};return d}]),lbiApp.factory("queryNearPoi",["$q",function(a){var b=function(b,c,d,e){var f=d||1e3,g=a.defer(),h=[],i=1;return AMap.service(["AMap.PlaceSearch"],function(){var a=new AMap.PlaceSearch({pageSize:50,pageIndex:i,type:e}),d=function(){a.searchNearBy(b,c,f,function(b,f){"complete"==b&&"OK"==f.info?(h=h.concat(f.poiList.pois),h.length<f.poiList.count?(i+=1,a.setPageIndex(i),d()):g.resolve({type:e,center:c,count:f.poiList.count,pois:h})):g.resolve({type:e,center:c,count:0,pois:[]})})};d()}),g.promise};return b}]),lbiApp.factory("queryNearPoiByBatch",["$q","queryNearPoi",function(a,b){var c=function(c){var e=a.defer(),f=c.locs,g=c.keys,h=[];return $.each(g,function(a,c){var d=c.key,e=c.type;$.each(f,function(a,c){var f=c.split(","),g=new AMap.LngLat(f[0],f[1]);h.push(b(d,g,1e3,e))})}),a.all(h).then(function(a){d(a,e)}),e.promise},d=function(a,b){var c={};$.each(a,function(a,b){var d=b.center,e=d.getLng()+","+d.getLat();c[e]=c[e]||{},c[e][b.type]=b}),b.resolve(c)};return c}]),lbiApp.factory("queryDistrict",["$q",function(a){var b,c;AMap.service(["AMap.DistrictSearch"],function(){var a={subdistrict:1,extensions:"all",level:"district"};b=new AMap.DistrictSearch(a)});var d=function(d,e){c=a.defer();var f=d.cityname.replace(/\u5e02/,"");return-1!="北京上海天津重庆".indexOf(f)&&(f+="市市辖区"),level=e||"city",b.setLevel(level),b.search(f,function(a,b){if("complete"==a&&"OK"==b.info)if("city"==level)c.resolve(b.districtList[0].districtList);else if("district"==level&&b.districtList[0].boundaries.length){var d=$.map(b.districtList[0].boundaries[0],function(a){return a.lng+" "+a.lat});c.resolve({wkt:d})}}),c.promise};return d}]),lbiApp.factory("queryCityListByCrowdParams",["$q","lbiService",function(a,b){return function(c){var d=a.defer();if(c.hasOwnProperty("flag")){var e=c.flag,f="2"==e?"getCitylist":"getCitylistByFilter",g="2"==e?"GET":"POST",h="2"==e?{}:c;b(f,h,g).then(function(a){d.resolve(a)},function(a,b){d.reject(a,b)})}else d.reject("参数传递错误","");return d.promise}}]),lbiApp.factory("marketActiveList",["userStatus","$q",function(a,b){var c=b.defer();return a.then(function(a){83675==a.memberId?c.resolve([{id:"123456",name:"林氏木业投放活动1"}]):c.reject("没有投放活动","")}),c.promise}]),lbiApp.factory("getDateFormat",[function(){var a=function(a){var b,c,d;return b=a.getFullYear(),c=a.getMonth()+1,d=a.getDate(),[b,c,d].join("-")},b=function(b){var c,d=+new Date;switch(b){case"yesterday":c=new Date(d-864e5);break;case"lastweek":c=new Date(d-6048e5);break;default:c=new Date}return a(c)};return b}]),lbiApp.factory("getTrades",["lbiService","$q",function(a,b){var c=b.defer();return a("getTrades",{},"POST").then(function(a){return c.resolve(a),!1}),c.promise}]);