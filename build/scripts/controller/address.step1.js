lbiApp.controller("addr.step1Ctrl",["$scope","$state","lbiService","fetureLabels","onlineShoplist","offlineListResource","getGridTileLegend","tileLegend","queryCityListByCrowdParams","tagEnitySwitch","SweetAlert","$timeout","formatwkt","safeApply",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){a.districtData=[];var o,p,q;cityTag="112117",districtTag="112706",reqParams={datatype:"C5"};var r=function(b){return a.curcode&&a.citycode!==a.curcode?(delete b[cityTag],b[districtTag]=[a.curcode]):(delete b[districtTag],b[cityTag]=[a.citycode]),b},s=function(){reqParams=$.extend(reqParams,{flag:a.crowdSourceChecked.replace("A",""),tagEntitys:{},adcode:a.citycode,usershopid:a.onlineTaobaoCheckedId,fileId:a.offlineMemberCheckedId,datatype:"C5"}),"1"==reqParams.flag&&(reqParams.tagEntitys[o]=[a.onlineTaobaoCheckedId]),delete reqParams.tagEntitys[districtTag],reqParams.tagEntitys[cityTag]=[a.citycode];var b=$.extend({},reqParams);b=$.extend(!0,b,{tagEntitys:p,adcode:a.citycode}),b.tagEntitys=j(b.tagEntitys),c("getDistribeCount",b,"POST").then(function(b){a.districtLegend=h(b[0].legends,"rank");var c=b[0].cityDistribeInfo;a.districtLegend=h(b[0].legends,"rank"),$.each(c,function(a,b){var c=[];$.each(b.wkt,function(a,b){c=c.concat(m(b))}),b.wkt=c}),a.districtData=c}).then(function(){return a.curcode==a.citycode?t():void 0}).then(function(){l(function(){var b;$.each(a.districtData,function(c,d){d.county===a.curcode&&(b=d.county)}),!b&&(b=a.districtData[0].county),a.curcode=b},100)})},t=function(){reqParams.tagEntitys=r(reqParams.tagEntitys);var b=$.extend({},reqParams);b=$.extend(!0,b,{tagEntitys:p}),b.tagEntitys=j(b.tagEntitys),c("getCount",b,"POST").then(function(b){a.reqError=!1,a.crowdCount=b[0].crowdCount},function(){a.reqError=!0,a.crowdCount=!1})},u=function(b){b.tagEntitys={},"1"==b.flag&&(b.tagEntitys[o]=[b.usershopid]),b.tagEntitys=j(b.tagEntitys),c("getCitylistByFilter",b,"POST").then(function(b){a.citylist=b},function(){a.reqError=!0,a.citylist=[{}],k.swal({title:"当前文件匹配人数过少!",text:"请选择其他线下会员文件或者使用线下淘宝店会员",confirmButtonColor:"#399eee",confirmButtonText:"确定"})}).then(function(){q=l(function(){s()},500)})},v=function(){reqParams.tagEntitys=r(reqParams.tagEntitys);var b=$.extend(!0,{size:600},reqParams);return b=$.extend(!0,b,{tagEntitys:p}),b.tagEntitys=j(b.tagEntitys),g(b).then(function(b){a.showTileThumb=!0,a.originLegends=b.legends,a.tileLegends=h(b.legends),a.gridSize=b.size}),!1},w=function(b){var d=$.extend(!0,{size:a.gridSize,section:b.join(";")},reqParams);d=$.extend(!0,d,{tagEntitys:p}),d.tagEntitys=r(d.tagEntitys),d.tagEntitys=j(d.tagEntitys),c("getGids",d,"POST").then(function(b){a.tileParams={gids:b[0].gids,bound:a.districtBound,legend:a.originLegends}})};a.crowdSourceList=[{type:"A0",name:"线下会员文件"},{type:"A1",name:"线上淘宝会员"},{type:"A2",name:"全淘宝会员"}],d.then(function(b){o=b[0].member[0].tagid,a.filterLabels=b[0].base}).then(function(){return e}).then(function(b){a.onlineTaobaoList=b,a.onlineTaobaoCheckedId=b[0].dataId,a.crowdSourceChecked="A1"}),f.query().then(function(b){a.offlineMemberList=b,a.offlineMemberCheckedId=b[0].id}),a.$watch("crowdSourceChecked+onlineTaobaoCheckedId",function(){"A1"==a.crowdSourceChecked&&a.onlineTaobaoCheckedId&&u({flag:"1",usershopid:a.onlineTaobaoCheckedId}),"A2"==a.crowdSourceChecked&&u({flag:"2"})}),a.$watch("crowdSourceChecked+offlineMemberCheckedId",function(){"A0"==a.crowdSourceChecked&&a.offlineMemberCheckedId&&u({flag:"0",fileId:a.offlineMemberCheckedId})}),a.checkcity=function(b){q&&l.cancel(q),a.citycode=b.citycode,a.cityname=b.cityname,a.curcode=b.citycode,s(),a.showTileThumb=!1},a.checkedFilterLabels=function(a){p=a,s()},a.showAllCountys=function(){a.showTileThumb=!1,a.tileParams={},a.curcountyname="",a.curcode=a.citycode,t()},a.showItemCounty=function(b,c){return a.curcountyname=c.name,Number(c.count)?void(!isNaN(c.count)&&Number(c.count)>150?(a.districtBound=b,v(),t()):n(a,function(){a.tileParams={},a.crowdCount=0,a.reqError=!0})):(a.showTileThumb=!1,!1)},a.selectLegends=function(b){b.length?w(b):a.tileParams={}},a.secondStep=function(){if(a.curcode==a.citycode||!a.crowdCount)return k.swal({title:"请选择区县",text:"请在地图上点击想要进行分析的区县",confirmButtonColor:"#399eee",confirmButtonText:"确定"}),!1;if(!a.crowdCount)return k.swal({title:"人数过少"}),!1;var c=$.extend(!0,{cityname:a.cityname,districtname:a.curcountyname,size:a.gridSize,districtcode:a.curcode},reqParams);c=$.extend(!0,c,{tagEntitys:p}),c.tagEntitys=j(c.tagEntitys),a.$emit("EMIT_TILE_PARAMS",c),a.$emit("EMIT_BOUND_PARAMS",a.districtBound,a.originLegends),b.go("index.address.step2",{city:a.cityname,district:a.curcountyname})}}]);