lbiApp.controller("createMarket.step1Ctrl",["$q","$scope","lbiService","fetureLabels","userStatus","onlineShoplist","offlineListResource","tagEnitySwitch","$state","judgeCircleGidsLen","judgeCircleCountLen","SweetAlert","queryPlaceBySearchPoi","querycircleByBatch","queryDistrict","myPoiResource",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){b.nextDisabled=!0;var q={},r=function(a){return q=$.extend(q,a),q.hasOwnProperty("flag")&&q.hasOwnProperty("featuretype")&&q.hasOwnProperty("datatype")?"B3"==q.featuretype&&q.activetime&&0==q.activetime.length?!1:(q.scale="B3"==q.featuretype?"0":b.multipleNum,b.$emit("PASS_CROWD_PARAMS",q),void s().then(t).then(u).then(function(){b.nextDisabled=!1},function(){b.nextDisabled=!0})):(b.crowdCount=0,b.nextDisabled=!0,!1)},s=function(){return c("getCrowdCount",$.extend({},q,{tagEntitys:h(q.tagEntitys||{})}),"POST")},t=function(a){b.crowdCount=a[0].crowdCount;var d=$.extend(!0,{},q);switch(d.tagEntitys=d.tagEntitys||{},d.flag){case"A0":delete d.usershopid;break;case"A1":delete d.fileId,d.tagEntitys[b.usershopTag]=[d.usershopid],delete d.usershopid;break;case"A2":delete d.fileId,delete d.usershopid}return d.tagEntitys=h(d.tagEntitys),c("getTagDateRange",d,"POST")},u=function(c){var d=a.defer(),e=c[0].endDate,f=c[0].startDate;return new Date(e).getTime()>new Date(f).getTime()?d.resolve({startDate:f,endDate:e}):(l.swal({title:"标签过期",text:"请修改标签有效期",confirmButtonColor:"#399eee",confirmButtonText:"确定"}),d.reject()),b.startDate=f,b.endDate=e,d.promise};d.then(function(a){var c=a[0];b.usershopTag=c.member[0].tagid}),b.crowdSourceList=[{name:"全淘宝会员",type:"A2"}],b.crowdSourceChecked="A2",b.offlineMemberList=[],b.onlineTaobaoList=[],g.query().then(function(a){b.offlineMemberList=a,b.crowdSourceList.splice(1,-1,{name:"线下会员文件",type:"A0"}),b.offlineMemberCheckedId=a[0].id}),f.then(function(a){b.onlineTaobaoList=a,b.onlineTaobaoCheckedId=a[0].dataId,b.crowdSourceList.push({name:"线上淘宝店会员",type:"A1"})});var v=["crowdSourceChecked","onlineTaobaoCheckedId","offlineMemberCheckedId"];b.$watch(v.join("+"),function(){if(!b.crowdSourceChecked)return!1;var a={};switch(b.crowdSourceChecked){case"A0":a={flag:"A0",fileId:b.offlineMemberCheckedId};break;case"A1":a={flag:"A1",usershopid:b.onlineT};break;case"A2":a={flag:"A2"}}r(a)}),b.crowdTypeList=[{name:"常驻人群",type:"B0"},{name:"近一周出现人群",type:"B1"},{name:"近一月出现人群",type:"B2"},{name:"实时人群",type:"B3"}],b.crowdTypeChecked="B0",b.updateRealtime=function(a){r({activetime:a.join(",")})},b.$watch("crowdTypeChecked",function(){return b.crowdTypeChecked?("B3"==b.crowdTypeChecked?(b.areaTypeList.splice(1,1),b.areaTypeList.pop()):b.areaTypeList.length!=w.length&&(b.areaTypeList=[].concat(w)),void("B3"!=b.crowdTypeChecked||"C1"!=b.areaTypeChecked&&"C4"!=b.areaTypeChecked?r({featuretype:b.crowdTypeChecked}):(b.areaCheckedList[b.areaTypeChecked]=[],b.areaCheckedGeoList[b.areaTypeChecked]=[],b.areaTypeChecked="C0",r({featuretype:b.crowdTypeChecked,datatype:b.areaTypeChecked,id:b.areaCheckedList[b.areaTypeChecked].join(",")})))):!1});var w=[{name:"自定义商圈",areaType:"C0"},{name:"系统商圈",areaType:"C1"},{name:"实体店周边",areaType:"C2"},{name:"兴趣点周边",areaType:"C3"},{name:"区县",areaType:"C4"}];b.areaTypeList=[].concat(w),b.customCircleList=[],b.sysCircleList=[],b.sysPage=1,b.sysKeyword="",b.physicalStoreList=[];var x=[{name:"1公里",value:1e3},{name:"2公里",value:2e3},{name:"3公里",value:3e3}];b.physicalStoreRadiusList=[].concat(x),b.areaCheckedRadius={C2:"1000",C3:"500"},b.poiList=[],b.poiStoreRadiusList=[{name:"500米",value:500},{name:"700米",value:700},{name:"1000米",value:1e3}],b.poiPageIndex=1,b.countryList=[],b.areaTypeChecked="C0",b.areaCheckedList={C0:[],C1:[],C2:[],C3:[],C4:[]},b.areaCheckedGeoList={C0:[],C1:[],C2:[],C3:[],C4:[]},b.checkcity=function(a){b.cityname=a.cityname,b.citycode=a.citycode,b.center=[a.lng,a.lat],b.areaCheckedList={C0:[],C1:[],C2:[],C3:[],C4:[]},b.sysPage=1,b.sysKeyword="",b.poiPageIndex=1};var y=function(){c("circleList",{citycode:b.citycode,all:!0},"GET").then(function(a){b.customCircleList=a[0].bizAreaInfo,0==b.areaCheckedList[b.areaTypeChecked].length&&b.toggleCircleItem([b.customCircleList[0].id])})},z=function(){c("sysCirclelist",{all:!1,citycode:b.citycode,pageNo:b.sysPage,keyword:b.sysKeyword}).then(function(a){b.sysCircleList=a[0].bizAreaInfo,b.sysTotal=a[0].totalCount,b.sysPage=a[0].pageNo,0==b.areaCheckedList[b.areaTypeChecked].length&&b.toggleCircleItem([b.sysCircleList[0].id])})},A=function(){c("getFiles",{}).then(B)},B=function(a){var d=a[0].id;c("getPhysicalStoreList",{adcode:b.citycode,fileid:d,ismatch:1}).then(function(a){b.physicalStoreList=a,0==b.areaCheckedList[b.areaTypeChecked].length&&b.toggleCircleItem([b.physicalStoreList[0].id])})},C=function(){p.query().then(function(a){b.poiList=a,b.checkedPoi=a[0].type})},D=function(){var a=$.grep(b.poiList,function(a){return a.type==b.checkedPoi})[0].desc;m({city:b.citycode,key:a,page:b.poiPageIndex,type:b.checkedPoi,pagesize:30}).then(function(a){b.poiStoreTotalPage=a.totalPage,b.poiStoreList=a.pois,0==b.areaCheckedList[b.areaTypeChecked].length&&b.toggleCircleItem([b.poiStoreList[0].id])})},E=function(){o({citycode:b.citycode,cityname:b.cityname}).then(function(a){b.countryList=a,b.checkedCountry=a[0].adcode})};b.$watch("checkedCountry",function(){return b.checkedCountry?(o({cityname:b.checkedCountry},"district").then(function(a){b.areaCheckedGeoList.C4=[a]}),void r({datatype:"C4",adcode:b.checkedCountry})):!1});var F=function(a){var c=[],d=[],e={};$.each(b.areaCheckedGeoList[a],function(a,b){e[b.id]=$.extend({},b)}),$.each(b.areaCheckedList[a],function(a,b){e.hasOwnProperty(b)?e[b].isFlag=!0:c.push(b)}),$.each(e,function(a,b){b.isFlag&&(delete b.isFlag,d.push(b))}),c.length?n(c).then(function(c){b.areaCheckedGeoList[a]=d.concat(c)}):b.areaCheckedGeoList[a]=d,r({datatype:a,id:b.areaCheckedList[a].join(",")})},G=function(){var a=[];$.each(b.areaCheckedList.C2,function(c,d){var e=$.grep(b.physicalStoreList,function(a){return a.id==d})[0];a.push({id:d,lng:e.x,lat:e.y,radius:b.areaCheckedRadius.C2})}),b.areaCheckedGeoList.C2=a,r({datatype:"C2",regions:$.map(a,function(a){return a.lng+","+a.lat}).join(";"),radius:b.areaCheckedRadius.C2})},H=function(){var a=[],c=[].concat(b.areaCheckedList.C3);$.each(b.poiStoreList,function(d,e){var f=$.inArray(e.id,c);-1!=f&&(a.push({lng:e.location.lng,lat:e.location.lat,id:e.id,radius:b.areaCheckedRadius.C3}),delete c[f])}),$.each(b.areaCheckedGeoList.C3,function(b,d){var e=$.inArray(d.id,c);-1!=e&&(a.push(d),delete c[e])}),b.areaCheckedGeoList.C3=a,r({datatype:"C3",regions:$.map(a,function(a){return a.lng+","+a.lat}).join(";"),radius:b.areaCheckedRadius.C3})},I=function(){switch(b.areaTypeChecked){case"C0":F("C0");break;case"C1":F("C1");break;case"C2":G();break;case"C3":H()}},J=function(){var a=[].concat(b.areaCheckedGeoList[b.areaTypeChecked]);$.each(a,function(a,c){c.radius=b.areaCheckedRadius[b.areaTypeChecked]}),b.areaCheckedGeoList[b.areaTypeChecked]=a};b.$watch("areaTypeChecked+citycode",function(){if(!b.citycode)return!1;switch(b.areaTypeChecked){case"C0":y();break;case"C1":z();break;case"C2":A();break;case"C3":C();break;case"C4":E()}b.areaCheckedList[b.areaTypeChecked].length&&I()}),b.$watch("sysPage+sysKeyword",function(){return"C1"!=b.areaTypeChecked?!1:void z()}),b.sysPaging=function(a){b.sysPage=a},b.$watch("areaCheckedRadius",function(){return 0==b.areaCheckedGeoList[b.areaTypeChecked].length?!1:void K()({regions:$.map(b.areaCheckedGeoList[b.areaTypeChecked],function(a){return a.lng+","+a.lat}).join(";"),type:b.areaTypeChecked,radius:b.areaCheckedRadius[b.areaTypeChecked]}).then(function(){r({radius:b.areaCheckedRadius[b.areaTypeChecked]}),J()},function(a){l.swal({title:"修改失败",text:a,confirmButtonColor:"#399eee",confirmButtonText:"确定"})})},!0),b.$watch("citycode+checkedPoi",function(){return b.checkedPoi&&b.citycode&&"C3"==b.areaTypeChecked?(b.areaCheckedList.C3=[],b.areaCheckedGeoList.C3=[],b.poiPageIndex=1,void D()):!1}),b.poiStorePaging=function(a){return b.poiPageIndex=a,b.checkedPoi?void D():!1};var K=function(){return"B3"!==b.crowdTypeChecked&&"C1"!==b.areaTypeChecked?j:k};b.toggleCircleItem=function(a){var c=[].concat(b.areaCheckedList[b.areaTypeChecked]);$.each(a,function(a,b){-1==$.inArray(b,c)&&c.push(b)});var d=$.inArray(a[0],b.areaCheckedList[b.areaTypeChecked]);if(a.length>1&&c.length==b.areaCheckedList[b.areaTypeChecked].length)return!1;if(-1!=d&&1==a.length&&1==b.areaCheckedList[b.areaTypeChecked].length)return!1;if(1==a.length&&-1!=d)b.areaCheckedList[b.areaTypeChecked].splice(d,1),I();else{var e={};switch(b.areaTypeChecked){case"C0":e={ids:c.join(","),type:"C0"};break;case"C1":e={ids:c.join(","),type:"C1"};break;case"C2":var f=[];$.each(b.physicalStoreList,function(a,b){-1!=c.join(",").indexOf(b.id)&&f.push(b.x+","+b.y)}),e={regions:f.join(";"),radius:b.areaCheckedRadius.C2,type:"C2"};break;case"C3":var f=[],g=[].concat(c);$.each(b.poiStoreList,function(a,b){var c=$.inArray(b.id,g);-1!=c&&(f.push(b.location.lng+","+b.location.lat),delete g[c])}),$.each(b.areaCheckedGeoList.C3,function(a,b){var c=$.inArray(b.id,g);-1!=c&&(f.push(b.lng+","+b.lat),delete g[c])}),e={regions:f.join(";"),radius:b.areaCheckedRadius.C3,type:"C3"}}K()(e).then(function(){b.areaCheckedList[b.areaTypeChecked]=c,I()},function(a){l.swal({title:"添加失败",text:a,confirmButtonColor:"#399eee",confirmButtonText:"确定"})})}},b.$on("UPDATE_FILTER_LABELS",function(a,b){r({tagEntitys:b})}),b.multipleNum=0,b.multiples={options:{range:"min",max:30,value:b.multipleNum,min:0,step:1}},b.updateMultipleNum=function(a){b.multipleNum=a,r({scale:a})},b.next=function(){i.go("index.crowd.step2",{count:b.crowdCount,startdate:b.startDate,enddate:b.endDate})}}]),lbiApp.controller("crowd.filterCtrl",["$scope","$state","fetureLabels","getTrades",function(a,b,c,d){c.then(function(b){var c=b[0];a.filterLabels=c.base}),d.then(function(b){a.tradeTag=b}),a.checkedMylabels={},a.inArray=$.inArray,a.selectlabel=function(b,c){var d=d||"checkbox",e=a.checkedMylabels[b]||[];if("checkbox"==d){var f=-1;f=$.inArray(c,e),-1===f?e.push(c):e.splice(f,1)}else"radio"==d&&(e=[c]);a.checkedMylabels[b]=e,a.$emit("UPDATE_FILTER_LABELS",a.checkedMylabels),a.checkedCall&&a.checkedCall({labels:a.checkedMylabels})},a.redirectToSecondTag=function(c,d){b.go("index.crowd.secondtag",{tagid:c,tagtype:d,tags:(a.checkedMylabels[c]||[]).join(",")})},a.$on("BROADCAST_CROWD_PARAMS",function(b,c){$.each(c.tagEntitys,function(b,c){a.checkedMylabels[b]=c})}),a.$on("$stateChangeSuccess",function(b,c,d){d.secondtags&&d.secondtagid&&(a.checkedMylabels[d.secondtagid]=d.secondtags.split(","),a.$emit("UPDATE_FILTER_LABELS",a.checkedMylabels))})}]);