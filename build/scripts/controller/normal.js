var lbiApp=angular.module("lbiApp");lbiApp.controller("normalUseCtrl",["$scope","lbiService","fetureLabels","onlineShoplist","offlineListResource","$state","safeApply","formatwkt","tagEnitySwitch","SweetAlert",function(a,b,c,d,e,f,g,h,i,j){var k,l,m="112117",n=function(c){c.tagEntitys=c.tagEntitys||{},"1"==c.flag&&(c.tagEntitys[l]=[c.usershopid]),c.tagEntitys=i(c.tagEntitys),b("getCitylistByFilter",c,"POST").then(function(b){a.citylist=b},function(b){a.reqError=!0,a.citylist=[],j.swal({title:"当前文件匹配人数过少!",text:b,confirmButtonColor:"#399eee",confirmButtonText:"确定"})})},o=function(){return k={flag:a.crowdType,usershopid:a.onlineTaobaoCheckedId,fileId:a.offlineMemberCheckedId,tagEntitys:{},adcode:a.citycode,datatype:"C5"},k.tagEntitys[m]=[a.citycode],"1"==k.flag&&(k.tagEntitys[l]=[k.usershopid]),b("getFileInfo",$.extend({},k,{tagEntitys:i(k.tagEntitys)}),"POST").then(p,q)},p=function(b){a.reqError=!1,a.crowdCount=b[0].crowdCount,a.$broadcast("MATCH_SUCCESSED",k)},q=function(){a.reqError=!0,a.$broadcast("MATCH_FAILED")};a.offlineMemberList=[],a.onlineTaobaoList=[];var r=function(){var c={};return c[l]=[a.onlineTaobaoCheckedId],b("getShopCount",{tagEntitys:i(c)})};a.$watch("crowdType+onlineTaobaoCheckedId",function(){"1"==a.crowdType&&a.onlineTaobaoCheckedId&&(c.then(r).then(function(b){a.totalCount=b[0].memberfilecount,a.matchPercent=100,a.matchCount=b[0].memberfilecount}),n({flag:"1",usershopid:a.onlineTaobaoCheckedId}))}),a.$watch("crowdType+offlineMemberCheckedId",function(){if("0"==a.crowdType&&a.offlineMemberCheckedId){var b=$.grep(a.offlineMemberList,function(b){return b.id==a.offlineMemberCheckedId})[0];a.totalCount=b.count,a.matchPercent=(100*b.percent).toFixed(2),a.matchCount=Math.floor(a.totalCount*b.percent),n({flag:"0",fileId:a.offlineMemberCheckedId})}}),e.query().then(function(b){a.offlineMemberList=b,a.offlineMemberCheckedId=b[0].id}),c.then(function(a){l=a[0].member[0].tagid}).then(function(){return d}).then(function(b){a.onlineTaobaoList=b,a.onlineTaobaoCheckedId=b[0].dataId,a.crowdType="1"}),a.areaTypeChecked="C5",a.checkcity=function(b){a.citycode=b.citycode,a.cityname=b.cityname,o(),a.$broadcast("BROADCAST_CUR_CITYINFO",b)}}]),lbiApp.controller("memberLocationCtrl",["$scope","lbiService","userStatus","getGridTileLegend","tileLegend","tagEnitySwitch","fetureLabels","SweetAlert","formatwkt","safeApply",function(a,b,c,d,e,f,g,h,i,j){var k={},l="112117",m="112706",n={},o=function(b){return a.poi.citycode!==a.curadcode?(delete b[l],b[m]=[a.curadcode]):(delete b[m],b[l]=[a.curadcode]),b},p=function(){if(!k.hasOwnProperty("datatype"))return!1;var a=$.extend(!0,{},k);a=$.extend(!0,a,{tagEntitys:n}),delete a.tagEntitys[m],a.tagEntitys=f(a.tagEntitys),b("getDistribeCount",a,"POST").then(q,r)},q=function(b){var c=b[0].cityDistribeInfo;return a.districtLegend=e(b[0].legends,"rank"),$.each(c,function(a,b){var c=[];$.each(b.wkt,function(a,b){c=c.concat(i(b))}),b.wkt=c}),a.districtData=c,a.curadcode==a.poi.citycode?s():!1},r=function(b){h.swal({title:"无法绘制区县面!",text:b,confirmButtonColor:"#399eee",confirmButtonText:"确定"},function(){a.districtData=[]})},s=function(){var a=$.extend(!0,{},k);a=$.extend(!0,a,{tagEntitys:n}),a.tagEntitys=o(a.tagEntitys),a.tagEntitys=f(a.tagEntitys),b("getCount",a,"POST").then(t,u)},t=function(b){a.reqError=!1,a.crowdCount=b[0].crowdCount},u=function(){a.crowdCount=!1,a.districtData=[],a.reqError=!0,a.tileParams={},a.showTileThumb=!1,a.curcountyname=void 0},v=function(){var b=$.extend(!0,{size:600},k);return b=$.extend(!0,b,{tagEntitys:n}),b.tagEntitys=o(b.tagEntitys),b.tagEntitys=f(b.tagEntitys),d(b).then(function(b){a.showTileThumb=!0,a.originLegends=b.legends,a.gridSize=b.size,a.tileLegends=e(b.legends)}),!1},w=function(c){var d=$.extend(!0,{size:a.gridSize,section:c.join(";")},k);d=$.extend(!0,d,{tagEntitys:n}),d.tagEntitys=o(d.tagEntitys),d.tagEntitys=f(d.tagEntitys),b("getGids",d,"POST").then(function(b){a.tileParams={gids:b[0].gids,bound:a.districtBound,legend:a.originLegends}})};c.then(function(a){useId=a.memberId}),a.$on("BROADCAST_CUR_CITYINFO",function(b,c){a.poi=c,a.curadcode=c.citycode}),a.selectLegends=function(b){b.length?w(b):a.tileParams={}},a.showAllCountys=function(){a.showTileThumb=!1,a.tileParams={},a.curcountyname="",a.curadcode=a.poi.citycode,s()},a.showItemCounty=function(b,c){return a.curcountyname="-"+c.name,a.curadcode=c.id,Number(c.count)?void(!isNaN(c.count)&&Number(c.count)>150?(a.districtBound=b,v(),s()):j(a,function(){a.tileParams={},a.crowdCount=0,a.reqError=!0})):(a.showTileThumb=!1,!1)},a.$on("MATCH_SUCCESSED",function(a,b){k=$.extend({},b),p()}),a.$on("MATCH_FAILED",function(){a.reqError=!0,k={},u()}),g.then(function(b){a.filterLabels=b[0].base}),a.checkedFilterLabels=function(a){n=a,p()}}]),lbiApp.controller("circleRankCtrl",["$scope","lbiService","safeApply","formatwkt","fetureLabels","tagEnitySwitch","tileLegend",function(a,b,c,d,e,f,g){var h,i,j="112117",k=function(){b("getRankOfCircleByNum",h).then(function(b){$.each(b[0].sysAreaInfo,function(a,b){b.wkt=d(b.wkt)}),a.rankLegend=g(b[0].legends,"rank"),a.rank=b[0].sysAreaInfo.slice(0,20),a.curPage=1,a.reqError=!1},function(){a.reqError=!0})},l=function(c){delete h.tagEntitys[j],h.tagEntitys[i]=[c.id];var d=$.extend({size:300},h,{datatype:"C1"});d.tagEntitys=f(d.tagEntitys),b("getLegends",d,"POST").then(function(b){a.showTileThumb=!0,a.originLegends=b,a.tileLegends=g(b)})},m=function(c){var d=$.extend({size:300,section:c.join(";")},h,{datatype:"C1"});d.tagEntitys=f(d.tagEntitys),b("getGids",d,"POST").then(function(b){a.showTileThumb=!0,a.tileParams={gids:b[0].gids,bound:a.curCircleBound,legend:a.originLegends}})};a.size=10,a.curPage=1,a.rank=[],a.totalCount=0,a.$watch("curPage",function(b){isNaN(b)||(a.tileParams={},a.showTileThumb=!1)}),a.$on("MATCH_SUCCESSED",function(a,b){h=$.extend({},b),k()}),a.$on("MATCH_FAILED",function(){a.reqError=!0,a.rank=[],a.tileParams={},a.showTileThumb=!1,h={}}),a.$on("BROADCAST_CUR_CITYINFO",function(b,c){a.poi=c,a.curadcode=c.citycode}),a.selectLegends=function(b){b.length?m(b):a.tileParams={}},a.zoom=function(b){a.selectedIndex=b},e.then(function(a){i=a[0].circle[0].tagid}),a.showItemCounty=function(b,c){return isNaN(c.count)||Number(c.count)<=150?!1:(a.curCircleBound=b,a.curCircleInfo=c,void l(c))}}]),lbiApp.controller("halfYearRankCtrl",["$scope","lbiService","formatwkt","tileLegend",function(a,b,c,d){var e={},f=function(){delete e.tagEntitys,b("getRankOfArea",e).then(function(b){$.each(b[0].distInfo,function(a,b){b.wkt=c(b.wkt),b.id=(""+b.x+b.y).replace(".","")}),a.rankLegend=d(b[0].legends,"rank"),a.rank=b[0].distInfo,a.curPage=1,a.reqError=!1},function(){a.reqError=!0,a.rank=[]})};a.size=10,a.curPage=1,a.rank=[],a.$on("MATCH_SUCCESSED",function(a,b){e=$.extend({},b),f()}),a.$on("MATCH_FAILED",function(){a.reqError=!0,e={},a.showTileThumb=!1,a.tileParams={},a.rank=[]}),a.$on("BROADCAST_CUR_CITYINFO",function(b,c){a.poi=c}),a.zoom=function(b){a.selectedIndex=b,a.zoomIndex=b-(a.curPage-1)*a.size},a.hoverCircleItem=function(b,c){a.hoverIndex=c+(a.curPage-1)*a.size}}]),lbiApp.controller("oftenpoiCtrl",["$scope","lbiService","tagEnitySwitch",function(a,b,c){var d={},e=function(){if(!d.hasOwnProperty("flag"))return!1;var e=$.extend({},d);e.tagEntitys=c(e.tagEntitys),b("gonePOIRank",e).then(function(b){a.reqError=!1,a.rank=b,a.curPage=1})};a.size=10,a.curPage=1,a.rank=[],a.poitypes=[{name:"餐饮服务",type:"050000"},{name:"超市",type:"060400"},{name:"体育休闲",type:"080000"}],a.poitype="050000",a.$on("MATCH_SUCCESSED",function(a,b){d=$.extend(d,b),e()}),a.$on("MATCH_FAILED",function(){a.reqError=!0}),a.$on("BROADCAST_CUR_CITYINFO",function(b,c){a.poi=c}),a.$watch("poitype",function(a){d=$.extend(d,{poitype:a}),e()})}]),lbiApp.controller("memberMsgCtrl",["$scope","lbiService","tagEnitySwitch",function(a,b,c){function d(){var d=$.extend({},f);d.tagEntitys=c(d.tagEntitys),b("getMemberMsg",d).then(function(b){a.reqError=!1,e(b)},function(){a.reqError=!0})}function e(b){var c={};$.each(b,function(a,b){var d=b[0],e=g[d];c[e]=b[2]}),a.dataSource=c}a.dataSource={};var f={},g={2:"gender",3:"job",4:"city",7:"amout_consume",8:"avg_consume",1:"age",9:"shop_discount",11:"fav_point",111330:"click_perf",111159:"buy_prefer",111053:"has_child",111067:"wireless_online_range_7d",111066:"pc_online_range_7d",22212:"app_type",22211:"user_tag"};a.$on("MATCH_SUCCESSED",function(a,b){f=$.extend({},b),d()}),a.$on("MATCH_FAILED",function(){reqError=!0,f={}})}]);