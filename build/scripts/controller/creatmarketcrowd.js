var lbiApp=angular.module("lbiApp");lbiApp.controller("createMarketCtrl",["$scope","$state","lbiService",function(a,b,c){function d(){c("createCrowd",function(c){c.success(function(c){return c.success?(alert("成功创建营销人群"),b.go("root.normal"),!1):(alert("创建失败！请重新尝试！"),void(a.step=1))})},a.params,"POST")}a.step=1,a.params={},a.$on("$stateChangeSuccess",function(a,b,c){e(c.circleid,c.fileid)}),a.$on("UPDATE_CREATCROWD_PARAMS",function(b,c){a.params=$.extend(a.params,c),c.hasOwnProperty("crowdName")&&d()}),a.$on("UPDATE_STEP",function(b,c){a.step=c});var e=function(b,c){a.$broadcast("UPDATE_CIRCLEID_FILEID",b,c)}}]),lbiApp.controller("getMarketCtrl",["$scope","lbiService","commonDataShare","broadcastBetweenCtrls","$state",function(a,b,c,d,e){function f(a){var b=[];return $.each(a,function(a,c){b.push({id:a,value:c})}),JSON.stringify(b)}function g(){var c={fileId:a.fileid,id:a.circleid,tagEntitys:f(a.checkedLabels)};return""==c.fileId||""==c.id?!1:void b("getCount",function(b){b.success(function(b){a.timeStamp=(new Date).getTime(),b.success?(a.reqError=!1,a.filterCount=b.info[0].crowdCount,d.trigger("SHARE_FILTER_CROWD",a.filterCount)):a.reqError=!0})},c,"POST")}function h(){return""==a.circleid?!1:void b("getCurPoi",function(b){b.success(function(b){a.curPoiMsg.lnglat=[b.info[0].x,b.info[0].y],a.curPoiMsg.city=b.info[0].city,a.radius=Number(b.info[0].radius)})},{id:a.circleid})}a.tileurl="/lbi/tile/drawTile",a.tileParams={},a.reqError=!0,a.featureLabels=[],a.filterCount=0,a.checkedLabels={},a.circleid="",a.fileid="",a.curPoiMsg={city:"",lnglat:[]},a.radius=0,a.cancel=function(){e.go("root.normal")},c("tile_thumb",function(b){a.tileThumbs=b}),b("checkLogin",function(b){a.memberId=b.userInfo.memberId}),c("feature_labels",function(b){a.featureLabels=b}),a.$on("UPDATE_CIRCLEID_FILEID",function(b,c,d){a.circleid=c,a.fileid=d,h()}),a.selectLable=function(b,c){var d=a.checkedLabels[b]||[],e=-1;return e=$.inArray(c,d),-1==e?d.push(c):d.splice(e,1),a.checkedLabels[b]=d,!1},a.$watch("checkedLabels",function(){g(),d.trigger("UPDATE_DATE_RANGE",f(a.checkedLabels))},!0),a.nextStep=function(){a.$emit("UPDATE_CREATCROWD_PARAMS",{fileId:a.fileid,id:a.circleid,tagEntitys:f(a.checkedLabels)}),a.$emit("UPDATE_STEP",2)},a.$watch("timeStamp",function(){a.reqError===!0?a.tileParams={}:a.reqError===!1&&(a.tileParams={c:13,fileId:a.fileid,id:a.circleid,memberId:a.memberId,tagEntitys:f(a.checkedLabels)})})}]),lbiApp.controller("sendCrowdCtrl",["$scope","broadcastBetweenCtrls","lbiService","$state",function(a,b,c,d){a.startDate="",a.endDate="",a.permission=!1,a.datepickeroptions={},b.on("SHARE_FILTER_CROWD",function(b){a.count=b}),a.back=function(){a.$emit("UPDATE_STEP",1)},a.cancel=function(){d.go("root.normal")},b.on("UPDATE_DATE_RANGE",function(b){c("getTagDateRange",function(b){b.success(function(b){a.startDate=b.info[0].startDate,a.endDate=b.info[0].endDate,a.curDate=b.info[0].startDate})},{tagEntitys:b},"POST")}),a.$watch("crowdName",function(){a.permission=0!==$.trim(a.crowdName).length}),a.createComplete=function(){a.$emit("UPDATE_CREATCROWD_PARAMS",{crowdName:a.crowdName,validetime:a.curDate})},a.$on("$destroy",function(){b.off(["SHARE_FILTER_CROWD","UPDATE_DATE_RANGE"])})}]);